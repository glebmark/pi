# Step 4: GitOps with Flux CD

This guide sets up [Flux CD](https://fluxcd.io/) to manage your cluster's infrastructure
and applications declaratively from a Git repository. After this step, every component
from Step 3 (Cilium, MetalLB, Nginx Gateway Fabric, etc.) will be defined as code in
your repo — push a change, and Flux reconciles the cluster automatically.

## Prerequisites

- Completed Steps 1–3 (Kubernetes cluster is running with all components)
- The `pi` repo pushed to GitHub
- `kubectl` access to the cluster from your Mac (via `config-rpi`)

## What Flux will manage

| Component | Flux resource type | Namespace |
|---|---|---|
| Cilium | HelmRelease | kube-system |
| MetalLB | HelmRelease + raw manifests | metallb-system |
| Nginx Gateway Fabric | HelmRelease | nginx-gateway |
| cert-manager | HelmRelease | cert-manager |
| Gateway API CRDs | Kustomization (remote git) | — |
| local-path-provisioner | Kustomization (remote git) | local-path-storage |
| Gateway (main-gateway) | raw manifest | default |
| Your apps | raw manifests / HelmRelease | any |

What stays **manual** (Steps 1–3): OS install, Linux preparation, `kubeadm init`,
Helm CLI, secondary IP workaround, kubeconfig copy.

## Repo structure

Flux manifests live under `cluster/` in your existing `pi` repo:

```
cluster/
  flux-system/              # auto-generated by flux bootstrap
  infrastructure.yaml       # top-level: wires sources → controllers → configs
  apps.yaml                 # top-level: wires apps (depends on infra)
  infrastructure/
    sources/                # HelmRepository definitions
      cilium-repo.yaml
      metallb-repo.yaml
      nginx-gw-repo.yaml
      jetstack-repo.yaml
    controllers/            # HelmRelease definitions
      cilium.yaml
      metallb.yaml
      nginx-gateway.yaml
      cert-manager.yaml
    configs/                # Raw manifests and remote Kustomizations
      gateway-api-crds.yaml
      metallb-config.yaml
      local-path.yaml
      gateway.yaml
  apps/                     # Your applications go here
```

### Dependency ordering

Flux reconciles in order using `dependsOn`:

```
sources → controllers → configs → apps
```

Within controllers: Cilium first, then MetalLB (needs CNI), then NGF (needs LB).
Within configs: waits for controllers so CRDs (MetalLB, Gateway API) exist before
creating instances (IPAddressPool, Gateway).

## Install the Flux CLI

On your **Mac** (not the Pi — Flux is managed from outside):

```bash
brew install fluxcd/tap/flux
```

Verify:

```bash
flux --version
```

Check that your cluster meets Flux requirements:

```bash
flux check --pre
```

## Create a GitHub Personal Access Token

Flux needs a token to push its own manifests to your repo.

1. Go to [github.com/settings/tokens](https://github.com/settings/tokens?type=beta)
2. Click **Generate new token** (Fine-grained)
3. Name: `flux-pi`
4. Repository access: select **Only select repositories** → choose your `pi` repo
5. Permissions → Repository permissions:
   - **Administration**: Read and write (needed to create a deploy key)
   - **Contents**: Read and write
   - **Metadata**: Read-only (auto-selected)
6. Click **Generate token** and copy it

Export the token:

```bash
export GITHUB_TOKEN=<your-token>
```

## Bootstrap Flux

This installs Flux components in the cluster and connects them to your GitHub repo.
It creates `cluster/flux-system/` with Flux's own manifests and commits them.

```bash
flux bootstrap github \
  --owner=<your-github-username> \
  --repository=pi \
  --path=cluster \
  --personal \
  --branch=main
```

Flux will:
1. Install its controllers in `flux-system` namespace
2. Create a `GitRepository` source pointing to your repo
3. Create a `Kustomization` that reconciles everything under `cluster/`
4. Commit the Flux system manifests to `cluster/flux-system/` and push

Wait for it to complete, then verify:

```bash
flux check
kubectl -n flux-system get pods
```

All pods should be Running.

## Pull the Flux system commit

Flux pushed a commit to your repo. Pull it locally:

```bash
cd ~/code/pi
git pull
```

You should see the new `cluster/flux-system/` directory.

## Apply the infrastructure and apps Kustomizations

The `cluster/infrastructure.yaml` and `cluster/apps.yaml` files define the top-level
Flux Kustomizations that wire everything together. Push them (they're already in the
repo from our setup):

```bash
git add cluster/
git commit -m "Add Flux infrastructure and apps manifests"
git push
```

Flux will detect the push and start reconciling. Watch the progress:

```bash
# Top-level Kustomizations
flux get kustomizations -w

# HelmReleases
flux get helmreleases --all-namespaces
```

## Flux adopting existing Helm releases

Since Cilium, MetalLB, NGF, and cert-manager are already installed via Helm, Flux
will **adopt** them. When a `HelmRelease` CR is created with the same release name
and target namespace, Flux takes ownership on the next reconciliation cycle.

You may see brief "upgrade" activity as Flux runs `helm upgrade` to ensure the
release matches the declared state. This is normal and non-disruptive as long as the
values match what's already deployed.

Verify all releases are managed:

```bash
flux get helmreleases --all-namespaces
```

Expected output:

```
NAMESPACE        NAME          REVISION  SUSPENDED  READY  MESSAGE
kube-system      cilium        1.19.x    False      True   Helm upgrade succeeded
metallb-system   metallb       ...       False      True   Helm upgrade succeeded
nginx-gateway    ngf           ...       False      True   Helm upgrade succeeded
cert-manager     cert-manager  ...       False      True   Helm upgrade succeeded
```

## Verify everything

```bash
# All Flux Kustomizations should be Ready
flux get kustomizations

# All HelmReleases should be Ready
flux get helmreleases -A

# Cluster should be healthy
kubectl get nodes
kubectl get pods -A
kubectl get gateway main-gateway
```

## How to make changes going forward

### Change a Helm value

Edit the HelmRelease file, commit, and push. For example, to change Cilium's operator
replicas:

```bash
# Edit cluster/infrastructure/controllers/cilium.yaml
# Change operator.replicas from 1 to 2

git add -A && git commit -m "Scale Cilium operator to 2 replicas"
git push
```

Flux detects the change and runs `helm upgrade` automatically.

### Add a new application

Create a manifest in `cluster/apps/` and add it to the kustomization:

```bash
mkdir -p cluster/apps/echo-server
```

Create `cluster/apps/echo-server/deployment.yaml`:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo
  namespace: default
spec:
  replicas: 2
  selector:
    matchLabels:
      app: echo
  template:
    metadata:
      labels:
        app: echo
    spec:
      containers:
        - name: echo
          image: ealen/echo-server:latest
          ports:
            - containerPort: 80
          env:
            - name: PORT
              value: "80"
---
apiVersion: v1
kind: Service
metadata:
  name: echo
  namespace: default
spec:
  selector:
    app: echo
  ports:
    - port: 80
      targetPort: 80
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: echo
  namespace: default
spec:
  parentRefs:
    - name: main-gateway
  hostnames:
    - "echo.rara.local"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: echo
          port: 80
```

Create `cluster/apps/echo-server/kustomization.yaml`:

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - deployment.yaml
```

Update `cluster/apps/kustomization.yaml`:

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - echo-server/
```

Commit and push:

```bash
git add -A && git commit -m "Add echo-server app"
git push
```

Flux deploys it automatically. Check:

```bash
flux get kustomizations
kubectl get pods -l app=echo
curl -s -H "Host: echo.rara.local" http://192.168.86.200/ | jq .
```

### Force an immediate reconciliation

Instead of waiting for the interval (30m), trigger manually:

```bash
flux reconcile kustomization flux-system --with-source
```

### Suspend/resume a resource

```bash
# Pause Flux management of a HelmRelease
flux suspend helmrelease cilium -n kube-system

# Resume
flux resume helmrelease cilium -n kube-system
```

## Useful Flux commands

```bash
# Overall status
flux get all -A

# Watch reconciliation in real time
flux get kustomizations -w

# Check what Flux is doing
flux logs --level=error

# See all Flux-managed resources
flux tree kustomization flux-system

# Debug a failing HelmRelease
flux get helmrelease <name> -n <namespace>
kubectl describe helmrelease <name> -n <namespace>
```

## Troubleshooting

### HelmRelease stuck in "not ready"

```bash
kubectl describe helmrelease <name> -n <namespace>
flux logs --kind=HelmRelease --name=<name> --namespace=<namespace>
```

Common causes: chart version not found, values schema error, dependency not ready.

### Kustomization stuck

```bash
flux get kustomization <name>
flux logs --kind=Kustomization --name=<name>
```

### Flux not picking up changes

```bash
# Force source refresh
flux reconcile source git flux-system

# Force full reconciliation
flux reconcile kustomization flux-system --with-source
```

### Reset Flux entirely

```bash
flux uninstall --namespace=flux-system
# Then re-run flux bootstrap
```
